---
title: "Final Presentation"
---

[Link to RMD Dashboard](https://chantanmorinjr.shinyapps.io/FinalProjectDashboard2/)

<iframe width="800" height="600" src="https://chantanmorinjr.shinyapps.io/FinalProjectDashboard2/">

</iframe>

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='hide', eval=FALSE}
# CCMR Analysis Rebuild
# This script focuses on CCMR variables and removes control variables from primary visualizations.

### 1. Packages and Setup
# Install packages if they are missing (commented out to prevent auto-run issues)
# install.packages(c("plotly", "shiny", "ggplot2", "rmarkdown", "tidyverse", "ggridges", "GGally", "RColorBrewer", "viridis", "extrafont", "ggpubr"), repos = "http://cran.rstudio.com/")

library(plotly)
library(shiny)
library(ggplot2)
library(rmarkdown)
library(tidyverse)
library(ggridges)
library(GGally)
library(RColorBrewer)
library(viridis)
library(extrafont)
library(ggpubr)
library(readr)
library(sjPlot)

# Use standard font to avoid "invalid font type" errors
font_family <- "sans"

### 2. Data Loading and Cleaning
# Load the new dataset
raw_data <- read.csv("FinalData.csv")

# Map new variables to the logic of the old script
# Old Variable                -> New Variable
# VoterTurnoutRate            -> GraduationRates (and other CCMR vars)
# MedianHouseholdIncome       -> PovertyRate (Socio-economic proxy)
# ObesityRate                 -> ViolentRate (Health/Social stressor)
# FoodInsecurity              -> PropertyRate (Economic stressor)
# LimitedAccesstoHealthyFoods -> MobilityRate (Stability indicator)
# Region                      -> CountyCode (Derived from DistrictNumber)

# Create CountyCode to serve as "Region"
# DistrictNumber is typically 6 digits, first 3 are County Code.
raw_data <- raw_data %>%
    mutate(
        # Ensure DistrictNumber is a string, pad with leading zeros if necessary (though usually read as int)
        DistrictStr = sprintf("%06d", DistrictNumber),
        CountyCode = substr(DistrictStr, 1, 3),
        RegionLabel = case_when(
            CountyCode == "057" ~ "Dallas",
            CountyCode == "220" ~ "Tarrant",
            CountyCode == "101" ~ "Harris",
            TRUE ~ CountyCode
        )
    )

# Select and rename columns for clarity in analysis
data <- raw_data %>%
    select(
        Name,
        TotalPopulation,
        Region = RegionLabel, # Mapping RegionLabel to Region
        GraduationRates, # Target Variable 1
        CCMR.Grads, # Target Variable 2
        CCMR.College, # Target Variable 3
        TSI.Both, # Target Variable 4
        DualCredit, # Target Variable 5
        APBI, # Target Variable 6
        Associates, # Target Variable 7
        OnRamps, # Target Variable 8
        PovertyRate, # (was MedianHouseholdIncome)
        ViolentRate, # (was ObesityRate)
        PropertyRate, # (was FoodInsecurity)
        MobilityRate, # (was LimitedAccesstoHealthyFoods)
        heterogeneity6
    ) %>%
    filter(complete.cases(.)) # Filter missing data

data <- data %>%
  mutate(
    hover_txt = paste0(
      "District: ", Name,
      "<br>County: ", Region,
      "<br>Grad Rate: ", round(GraduationRates, 1), "%",
      "<br>CCMR Grads: ", round(CCMR.Grads, 1), "%",
      "<br>College-Ready Grads: ", round(CCMR.College, 1), "%",
      "<br>TSI Criteria Completion: ", round(TSI.Both, 1), "%",
      "<br>Dual-Credit Criteria Completion: ", round(DualCredit, 1), "%",
      "<br>AP/IB Criteria Completion: ", round(APBI, 1), "%",
      "<br>Associate's Criteria Completion: ", round(Associates, 1), "%",
      "<br>OnRamps Criteria Completion: ", round(OnRamps, 1), "%",
      "<br>Violent Rate: ", round(ViolentRate, 2), " per 1,000",
      "<br>Property Rate: ", round(PropertyRate, 2), " per 1,000",
      "<br>Poverty: ", round(PovertyRate, 1), "%",
      "<br>Residential Mobility: ", round(MobilityRate, 1), "%",
      "<br>Heterogeneity Index: ", round(heterogeneity6, 1)
    ),
    hover_txt1 = paste0(
      "District: ", Name,
      "<br>County: ", Region,
      "<br>Grad Rate: ", round(GraduationRates, 1), "%",
      "<br>Violent Rate: ", round(ViolentRate, 2), " per 1,000",
      "<br>Poverty: ", round(PovertyRate, 1), "%"
    ),
      hover_txt2 = paste0(
      "District: ", Name,
      "<br>County: ", Region,
      "<br>CCMR Grads: ", round(CCMR.Grads, 1), "%",
      "<br>Property Rate: ", round(PropertyRate, 2), " per 1,000",
      "<br>Residential Mobility: ", round(MobilityRate, 1), "%"
      ),
    hover_txt3 = paste0(
      "District: ", Name,
      "<br>County: ", Region,
      "<br>College-Ready Grads: ", round(CCMR.College, 1), "%",
      "<br>Property Rate: ", round(PropertyRate, 2), " per 1,000",
      "<br>Heterogeneity Index: ", round(heterogeneity6, 1)
    )
  )

# Define colors for the new "Regions" (Counties)
region_choices <- c("All", unique(data$Region))
num_counties <- length(unique(data$Region))

### 3. Visualizations

# --- Ridge Plot ---
# Distribution of CCMR Graduates by Region (County)
top_counties <- data %>%
    group_by(Region) %>%
    pull(Region)

p_ridge <- data %>%
    ggplot(aes(x = CCMR.Grads, y = Region, fill = Region)) +
    geom_density_ridges() +
    theme_ridges() +
    scale_x_continuous(breaks = c(40, 50, 60, 70, 80, 90, 100)) +
    theme(legend.position = "none") +
    labs(x = "CCMR Graduates (%)", y = "", title = "") +
    theme(text = element_text(family = font_family))

print(p_ridge)

### Correlation Matrix
# Relationships between CCMR and Crime variables (Removed Poverty/Mobility)
panel.hist <- function(x, ...) {
    usr <- par("usr")
    on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5))
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks
    len <- length(breaks)
    y <- h$counts / max(h$counts)
    rect(breaks[-len], 0, breaks[-1], y, col = "#17BEBB")
}

# Save settings
old_par <- par(no.readonly = TRUE)
par(family = font_family)

data %>%
    select(CCMR.Grads, CCMR.College, ViolentRate, PropertyRate) %>%
    plot(
        pch = 19,
        cex = 0.8,
        lower.panel = panel.smooth,
        diag.panel = panel.hist,
        col = "#0E7C7B",
        labels = c("CCMR Grads", "CCMR College", "Violent", "Property"),
        gap = 0.3,
        upper.panel = NULL,
        main = "Scatterplot Matrix: CCMR vs Crime"
    )

### Bubble Chart 1
# --- Bubble Chart 1: Violent Crime vs CCMR Grads (Size = Poverty) ---
p_bubble1 <- ggplot(data, aes(
    x = ViolentRate, y = GraduationRates, size = PovertyRate,
    color = Region, text = hover_txt1
)) +
    geom_point(alpha = 0.7, shape = 16) +
    scale_size(range = c(1, 10), name = "Poverty Rate", guide = "none") +
    theme_minimal() +
    labs(y = "CCMR Graduates", x = "Violent Crime Rate", title = "Violent Crime vs Graduation Rates (Size = Poverty)") +
    theme(text = element_text(family = font_family), legend.position = "none")

ggplotly(p_bubble1, tooltip = "text") %>% 
  layout(legend = list(x = 0.75, y = 1))

### Bubble Chart 2
p_bubble2 <- ggplot(data, aes(
    x = PropertyRate, y = CCMR.Grads, size = MobilityRate,
    color = Region, text = hover_txt2
)) +
    geom_point(alpha = 0.7, shape = 16) +
    scale_size(range = c(1, 10), name = "Mobility Rate", guide = "none") +
    theme_minimal() +
    labs(y = "CCMR Graduates Rate", x = "Property Crime Rate", title = "Property Crime vs CCMR Grads (Size = Mobility)") +
    theme(text = element_text(family = font_family), legend.position = "none")

ggplotly(p_bubble2, tooltip = "text") %>% 
  layout(legend = list(x = 0.75, y = 1))

### Bubble Chart 3
p_bubble2 <- ggplot(data, aes(
    x = PropertyRate, y = CCMR.College, size = heterogeneity6,
    color = Region, text = hover_txt3
)) +
    geom_point(alpha = 0.7, shape = 16) +
    scale_size(range = c(1, 10), name = "Heterogeneity Index", guide = "none") +
    theme_minimal() +
    labs(y = "CCMR Graduates Rate", x = "Property Crime Rate", title = "Property Crime vs CCMR College-Ready Grads (Size = Heterogeneity Index)") +
    theme(text = element_text(family = font_family), legend.position = "none")

ggplotly(p_bubble2, tooltip = "text") %>% 
  layout(legend = list(x = 0.75, y = 1))

### ShinyApp
# Full implementation of the interactive scatterplot explorer with Modern UI

ui <- fluidPage(
    # Custom CSS for Modern "React-like" Look
    tags$head(
        tags$style(HTML("
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

            body {
                background-color: #f4f6f8;
                color: #374151;
                font-family: 'Inter', sans-serif;
            }

            .container-fluid {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }

            h2 {
                font-weight: 600;
                color: #111827;
                margin-bottom: 24px;
                font-size: 24px;
            }

            .card {
                background-color: #ffffff;
                border-radius: 12px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                padding: 24px;
                margin-bottom: 24px;
                border: 1px solid #e5e7eb;
            }

            .control-label {
                font-weight: 600;
                font-size: 14px;
                color: #374151;
                margin-bottom: 8px;
            }

            .form-control {
                border-radius: 8px;
                border: 1px solid #d1d5db;
                padding: 8px 12px;
                box-shadow: none;
                transition: border-color 0.15s ease-in-out;
            }

            .form-control:focus {
                border-color: #6366f1;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }

            .selectize-input {
                border-radius: 8px !important;
                border: 1px solid #d1d5db !important;
                padding: 8px 12px !important;
                box-shadow: none !important;
            }

            .selectize-input.focus {
                border-color: #6366f1 !important;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
            }

            /* Custom Grid Layout */
            .dashboard-grid {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 24px;
            }

            @media (max-width: 768px) {
                .dashboard-grid {
                    grid-template-columns: 1fr;
                }
            }
        "))
    ),
    div(
        class = "container-fluid",
        h2("District Variable Explorer"),
        div(
            class = "dashboard-grid",
            # Control Panel
            div(
                class = "card",
                h4("Controls (Hue = Poverty)", style = "margin-top: 0; margin-bottom: 20px; font-size: 18px; font-weight: 600;"),
                selectInput("x_var", "Predictor (X-Axis)",
                    choices = c(
                        "Violent Crime Rate" = "ViolentRate",
                        "Property Crime Rate" = "PropertyRate"
                    ),
                    selected = "ViolentRate"
                ),
                selectInput("y_var", "Outcome (Y-Axis)",
                    choices = c(
                        "CCMR Grads" = "CCMR.Grads",
                        "CCMR College Ready" = "CCMR.College",
                        "Graduation Rates" = "GraduationRates",
                        "TSI Both" = "TSI.Both",
                        "Dual Credit" = "DualCredit",
                        "AP/IB" = "APBI",
                        "Associates Degree" = "Associates",
                        "OnRamps" = "OnRamps"
                    ),
                    selected = "CCMR.Grads"
                ),
                uiOutput("region_selector")
            ),

            # Visualization Panel
            div(
                class = "card",
                plotlyOutput("distPlot", height = "500px")
            )
        )
    )
)

server <- function(input, output) {
    output$region_selector <- renderUI({
        selectInput("region", "Filter by County", choices = region_choices)
    })

    output$distPlot <- renderPlotly({
        req(input$x_var, input$y_var)

        # Filter data based on region selection
        plot_data <- data
        if (!is.null(input$region) && input$region != "All") {
            plot_data <- plot_data %>% filter(Region == input$region)
        }

        # Get x and y variables
        x_var <- input$x_var
        y_var <- input$y_var

        # Create base ggplot
        p <- ggplot(plot_data, aes_string(x = x_var, y = y_var, fill = "PovertyRate", text = "hover_txt")) +
            geom_point(shape = 21, size = 3, color = "white", stroke = 0.5) +
            labs(
                x = names(which(c(
                    "Violent Crime Rate" = "ViolentRate",
                    "Property Crime Rate" = "PropertyRate"
                ) == x_var)),
                y = names(which(c(
                    "Graduation Rates" = "GraduationRates",
                    "CCMR Grads" = "CCMR.Grads",
                    "CCMR College Ready" = "CCMR.College",
                    "TSI Both" = "TSI.Both",
                    "Dual Credit" = "DualCredit",
                    "AP/IB" = "APBI",
                    "Associates Degree" = "Associates",
                    "OnRamps" = "OnRamps"
                ) == y_var))
            ) +
            theme_gray() +
            theme(
                text = element_text(family = font_family),
                axis.title = element_text(size = 12, face = "bold", color = "#374151"),
                axis.text = element_text(color = "#6b7280"),
                panel.grid.major = element_line(color = "#f3f4f6"),
                panel.grid.minor = element_blank(),
                legend.position = "none" # Hide legend in interactive plot for cleaner look
            )

        # Add regression line
        if (!is.null(input$region) && input$region == "All") {
            p <- p + geom_smooth(aes(group = 1), method = "lm", color = "red", alpha = 0.2, size = 0.8)
        } else {
            p <- p + geom_smooth(method = "lm", color = "red", alpha = 0.2, size = 0.8)
        }

        # Convert to Plotly with enhanced config
        ggplotly(p, tooltip = c("text")) %>%
            config(
                displayModeBar = TRUE,
                displaylogo = FALSE,
                modeBarButtonsToRemove = c(
                    "select2d", "lasso2d", "autoScale2d",
                    "hoverClosestCartesian", "hoverCompareCartesian"
                )
            ) %>%
            layout(
                hoverlabel = list(bgcolor = "azure2", font = list(family = "Inter")),
                margin = list(t = 20, r = 20, b = 20, l = 20)
            )
    })
}

# Run the application only in interactive mode
shinyApp(ui = ui, server = server)

### Map

[ArcGIS CCMR-Crime Comparisons Maps](https://chantanmorinjr.github.io/assets/DataColFinalProjectMap.html)

```

